pipeline {
    agent any

    environment {
        PROJECT_PATH = 'C:\\inetpub\\EmployeeManagement'       // Update if your csproj is in subfolder
        DEPLOY_PATH = 'C:\\inetpub\\Published\\EmpMangmnt'
    }

    stages {
        stage('Clone Repo') {
            steps {
                git url: 'https://github.com/TechXpert-in/EmployeeManagement.git', branch: 'main'
            }
        }

       // stage('Restore') {
       //     steps {
       //         bat "dotnet restore %PROJECT_PATH%"
      //      }
      //  }

      
        // stage('Clean Deployment Folder') {
        //    steps {
        //        bat '''
        //        rd /s /q "C:\\inetpub\\Published\\EmpMangmnt"
        //        mkdir "C:\\inetpub\\Published\\EmpMangmnt"
        //        '''
        //    }
        // }
   
        stage('Build') {
            steps {
                bat "dotnet clean"
                bat "dotnet build %PROJECT_PATH% --configuration Release"
            }
        }
        stage('Stop IIS Site') {
            steps {
                echo "üõë Stopping IIS Site..."
                bat 'powershell.exe Stop-WebSite -Name "EmpMangmnt"'
                bat 'ping -n 10 127.0.0.1 > nul'

            }
        }
        stage('Kill Processes Holding DLLs') {
            steps {
                bat 'taskkill /F /IM w3wp.exe || echo No w3wp running'
                bat 'taskkill /F /IM dotnet.exe || echo No dotnet running'
            }
        }
         
        stage('Publish') {
            steps {
                bat "dotnet publish %PROJECT_PATH% -c Release -o %DEPLOY_PATH%"
            }
        }

        stage('Restart IIS') {
            steps {
                bat "iisreset"
            }
        }
    }

    post {
        success {
            echo '‚úÖ Application published and deployed to IIS successfully!'
        }
        failure {
            echo '‚ùå Deployment failed. Please check the logs.'
        }
    }
}
